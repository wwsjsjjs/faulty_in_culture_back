## 项目结构

```
go_back/
├── cmd/
│   └── server/
│       └── main.go              # 程序入口
├── internal/
│   ├── models/
│   │   ├── ranking.go           # 排名数据模型
│   │   ├── user.go              # 用户数据模型
│   │   ├── savegame.go          # 存档数据模型
│   │   ├── chat.go              # 聊天会话与消息模型
│   ├── handlers/
│   │   ├── ranking_handler.go   # 排名API处理器
│   │   ├── user_handler.go      # 用户API处理器
│   │   ├── savegame_handler.go  # 存档API处理器
│   │   ├── chat_handler.go      # AI聊天API处理器
│   │   ├── message_handler.go   # 消息/异步任务API处理器
│   │   ├── auth_middleware.go   # 认证中间件
│   │   ├── ratelimit_middleware.go # 频率限制中间件
│   ├── database/
│   │   └── db.go                # 数据库配置与连接
│   ├── cache/
│   │   └── cache.go             # Redis缓存封装
│   ├── queue/
│   │   └── queue.go             # Redis Streams消息队列
│   ├── routes/
│   │   └── routes.go            # 路由配置
│   ├── config/
│   │   └── config.go            # 配置加载
│   ├── scheduler/
│   │   └── message_cleanup.go   # 定时清理任务
│   ├── websocket/
│   │   └── manager.go           # WebSocket管理
├── docs/                        # Swagger文档（自动生成）
├── go.mod                       # Go模块依赖
├── go.sum                       # 依赖校验
└── README.md                    # 项目说明
```


## 功能模块与接口说明

### 用户系统
- 用户注册与登录，支持频率限制，密码加密存储。
- 认证中间件，所有需要认证的接口需携带token。
- Token格式：`userID:username:timestamp`

#### 用户相关接口
- POST `/api/register` 用户注册（限流5次/分钟，IP级）
- POST `/api/login` 用户登录（限流10次/分钟，IP级）

### 排名系统
- 排名创建、查询、更新、删除，支持分页和获取排行榜前N名。
- 排名更新接口有用户级频率限制。

#### 排名相关接口
- POST `/api/rankings` 创建新排名
- GET `/api/rankings` 获取排名列表（分页）
- GET `/api/rankings/{id}` 获取单个排名
- PUT `/api/rankings/{id}` 更新排名（限流20次/分钟，用户级）
- DELETE `/api/rankings/{id}` 删除排名
- GET `/api/rankings/top` 获取排行榜前N名

### 消息/异步任务系统
- 使用Redis Streams实现异步消息队列，支持延迟消息。
- 消息请求和响应分别持久化。
- 定时清理任务可配置。

#### 消息相关接口
- POST `/api/send-message` 发送延迟消息（10秒后返回）
- GET `/api/query-result` 查询消息结果
- GET `/api/messages` 获取历史消息列表（支持分页和状态筛选）
- GET `/ws` WebSocket 实时消息推送

### 存档系统（需认证）
- 每个用户最多6个存档槽位，存储JSON字符串。
- 支持创建、读取、更新、删除，所有查询操作有缓存优化。
- 写操作有用户级频率限制。

#### 存档相关接口
- GET `/api/savegames` 获取用户所有存档
- GET `/api/savegames/{slot}` 获取指定槽位存档（1-6）
- PUT `/api/savegames/{slot}` 创建或更新存档（限流30次/分钟，用户级）
- DELETE `/api/savegames/{slot}` 删除存档（限流10次/分钟，用户级）

### AI聊天系统（需认证）
- 集成腾讯混元AI，异步处理，WebSocket推送AI回复。
- 聊天会话与消息持久化，支持历史查询。
- 会话列表有缓存优化。

#### AI聊天相关接口
- POST `/api/chat/start` 开始新的AI聊天会话
- POST `/api/chat/send` 发送消息给AI（异步，通过WebSocket返回）
- GET `/api/chat/sessions` 获取所有聊天会话
- GET `/api/chat/{session_id}` 获取聊天历史

### 认证与安全
- 认证中间件自动校验token，所有存档和AI聊天相关接口需认证。
- 频率限制中间件，防止接口滥用。

### 缓存与优化
- Redis缓存用于存档和聊天会话查询，减少数据库压力。
- 写操作自动清理相关缓存。

### 配置与运维
- 所有参数集中在`config.yaml`，支持Redis、数据库、消息队列、定时任务等配置。
- Swagger文档自动生成，详细参数和返回格式见 [Swagger 文档](http://localhost:8080/swagger/index.html)。

---

## 认证说明

需要认证的接口需在请求头中添加 `Authorization` token：
```
Authorization: {userID}:{username}:{timestamp}
```

示例：
```bash
# 登录获取token
curl -X POST http://localhost:8080/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"123456"}'

# 使用token访问需要认证的接口
curl -X GET http://localhost:8080/api/savegames \
  -H "Authorization: 1:test:1703059200"
```

---

## 其他说明
- 所有接口均有频率限制，具体规则见代码和Swagger文档。
- 支持WebSocket实时推送AI消息和异步任务结果。
- 支持定时清理历史消息，参数可配置。
- 详细接口参数和返回格式请参考Swagger文档。