# 配置检查和问题报告

## ⚠️ 需要填写的配置项

### 1. 环境变量配置（推荐方式）

**操作步骤**：
1. 复制 `.env.example` 为 `.env`
2. 修改以下配置项：

```bash
# 数据库密码（必须修改）
DB_PASSWORD=your-secure-password-here-change-this

# JWT密钥（必须修改，用于token签名）
JWT_SECRET=your-production-secret-key-change-this-to-random-string

# 腾讯混元AI API密钥（如果需要AI聊天功能）
HUNYUAN_API_KEY=your-hunyuan-api-key-here
```

### 2. 生产环境配置文件 (config.prod.yaml)

**已删除的占位符配置**（这些配置通过环境变量或docker-compose设置）：
- ~~`your-db-host`~~ → 通过Docker网络自动配置为`mysql`
- ~~`your-db-user`~~ → 通过环境变量 `DB_USER` 设置
- ~~`your-db-pass`~~ → 通过环境变量 `DB_PASSWORD` 设置
- ~~`your-redis-host`~~ → 通过Docker网络自动配置为`redis`
- ~~`your-redis-pass`~~ → 通过环境变量 `REDIS_PASSWORD` 设置
- ~~`your-production-secret-key`~~ → 通过环境变量 `JWT_SECRET` 设置

**需要手动配置**：
```yaml
ai:
  api_key: ""  # 请在这里填写腾讯混元API密钥，或使用环境变量 HUNYUAN_API_KEY
```

### 3. 开发环境配置文件 (config.yaml)

**AI配置**（如需使用AI聊天功能）：
```yaml
ai:
  api_key: ""  # 填写你的腾讯混元API密钥
```

**其他配置**：
- 数据库配置已正确（本地开发）
- Redis配置已正确（本地开发）

---

## ✅ 已修复的问题

### 1. Dockerfile
- **问题**：使用了不存在的Go版本 `golang:1.25-alpine`
- **修复**：改为 `golang:1.23-alpine`（当前最新稳定版）

### 2. docker-compose.yml
- **问题**：引用了不存在的 `init.sql` 文件
- **修复**：删除了该行配置（数据库会自动初始化）

### 3. 前端API接口
- **问题**：存档API路径不正确 (`PUT /savegames/{slot}`)
- **修复**：改为 `POST /api/savegame`

### 4. 排行榜功能
- **问题**：只有单一排行榜
- **修复**：实现了5个排行榜类型（总分榜、关卡榜、速度榜、收集榜、成就榜）

---

## 🎯 新增功能

### AI聊天功能
- ✅ 后端接口完整（会话管理、消息发送）
- ✅ 前端页面已创建 (`/chat`)
- ✅ Start页面添加了聊天按钮（右上角💬）
- ⚠️ 需要配置AI API Key才能使用

### 路由
- 新增：`/chat` - AI聊天页面

---

## 📋 使用Docker部署

### 开发环境
```bash
# 1. 创建.env文件
cp .env.example .env
# 编辑.env，设置密码和密钥

# 2. 启动服务
docker-compose up -d

# 3. 查看日志
docker-compose logs -f app
```

### 生产环境
```bash
# 使用生产配置
docker-compose -f docker-compose.prod.yml up -d
```

### 停止服务
```bash
docker-compose down
```

---

## 🔐 安全建议

1. **数据库密码**：使用强密码（至少16位，包含大小写字母、数字、特殊字符）
2. **JWT密钥**：使用随机生成的长字符串（至少32位）
3. **Redis密码**：生产环境建议设置密码
4. **环境变量**：不要将`.env`文件提交到Git

### 生成安全密钥示例
```bash
# Linux/Mac
openssl rand -base64 32

# Windows PowerShell
-join ((65..90) + (97..122) + (48..57) | Get-Random -Count 32 | % {[char]$_})
```

---

## 📝 配置优先级

应用会按以下顺序读取配置：
1. **环境变量**（最高优先级）
2. **配置文件** (config.yaml / config.prod.yaml)
3. **默认值**

Docker Compose 会自动设置环境变量，因此在容器中运行时：
- 数据库连接信息从环境变量读取
- AI API Key优先从 `HUNYUAN_API_KEY` 环境变量读取

---

## 🌐 API端点

### 用户认证
- `POST /api/register` - 注册
- `POST /api/login` - 登录

### 排行榜（5个榜单）
- `GET /api/rankings/{rank_type}` - 查询排行榜（rank_type: 1-5）
- `POST /api/rankings` - 更新分数（需要登录）

### 存档
- `GET /api/savegame?slot_number=1` - 查询存档
- `POST /api/savegame` - 创建/更新存档
- `DELETE /api/savegame?slot_number=1` - 删除存档
- `GET /api/savegame/all` - 查询所有存档

### AI聊天
- `GET /api/chat/sessions` - 会话列表
- `POST /api/chat/sessions` - 创建会话
- `POST /api/chat/sessions/:id/messages` - 发送消息
- `GET /api/chat/sessions/:id/messages` - 消息历史

---

## ⚠️ 可能的问题

### AI聊天不工作
- 检查是否配置了 `HUNYUAN_API_KEY`
- 检查API密钥是否有效
- 查看后端日志确认错误信息

### 排行榜显示空白
- 需要先登录
- 需要上传至少一次分数
- 检查后端日志

### 存档上传失败
- 检查是否登录
- 检查网络连接
- 确认后端服务运行正常

---

## 📞 下一步

1. **创建`.env`文件**并填写所需配置
2. **获取AI API Key**（访问腾讯混元官网）
3. **运行 `docker-compose up -d`** 启动服务
4. **访问前端应用**测试功能

如有问题，查看日志：
```bash
docker-compose logs -f app
```
